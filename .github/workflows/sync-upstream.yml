name: Sync with Upstream

on:
  schedule:
    # æ¯å¤© UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00) æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/router-for-me/Cli-Proxy-API-Management-Center.git || true
          git fetch upstream
          git fetch upstream --tags

      - name: Check for updates
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/main)
          if git merge-base --is-ancestor $UPSTREAM_SHA HEAD; then
            echo "already_up_to_date=true" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          else
            echo "already_up_to_date=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Updates available from upstream"
          fi

      - name: Get upstream latest release
        id: upstream_release
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° release ä¿¡æ¯
          RELEASE_INFO=$(curl -s https://api.github.com/repos/router-for-me/Cli-Proxy-API-Management-Center/releases/latest)
          UPSTREAM_TAG=$(echo "$RELEASE_INFO" | jq -r '.tag_name // empty')
          UPSTREAM_BODY=$(echo "$RELEASE_INFO" | jq -r '.body // empty')

          if [ -n "$UPSTREAM_TAG" ]; then
            echo "tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
            echo "has_release=true" >> $GITHUB_OUTPUT
            # ä¿å­˜ release body åˆ°æ–‡ä»¶ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
            echo "$UPSTREAM_BODY" > /tmp/upstream_release_body.md
            echo "ğŸ“¦ Upstream latest release: $UPSTREAM_TAG"
          else
            echo "has_release=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No upstream release found"
          fi

      - name: Check if release exists locally
        id: local_release
        if: steps.upstream_release.outputs.has_release == 'true'
        run: |
          UPSTREAM_TAG="${{ steps.upstream_release.outputs.tag }}"
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰è¯¥ tag çš„ releaseï¼ˆé€šè¿‡ API æ£€æŸ¥ï¼Œè€Œé tagï¼‰
          RELEASE_EXISTS=$(gh api repos/${{ github.repository }}/releases/tags/$UPSTREAM_TAG --silent 2>/dev/null && echo "true" || echo "false")
          if [ "$RELEASE_EXISTS" == "true" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Release $UPSTREAM_TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Release $UPSTREAM_TAG not found locally"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check existing conflict issue
        id: check_issue
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰æœªå…³é—­çš„åŒæ­¥å†²çª Issue
          EXISTING_ISSUE=$(gh issue list --state open --search "ä¸Šæ¸¸åŒæ­¥å†²çª in:title" --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
            echo "âš ï¸ Existing conflict issue #$EXISTING_ISSUE found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… No existing conflict issue"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        if: steps.check.outputs.already_up_to_date == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Merge upstream
        if: steps.check.outputs.already_up_to_date == 'false'
        id: merge
        run: |
          if git merge upstream/main --no-edit -m "Merge upstream changes $(date +%Y-%m-%d)"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Merge successful"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            # ä¿å­˜å†²çªæ–‡ä»¶åˆ—è¡¨
            git diff --name-only --diff-filter=U > /tmp/conflict_files.txt
            git merge --abort
            echo "âš ï¸ Merge conflict detected"
          fi

      - name: Build and package
        if: steps.check.outputs.already_up_to_date == 'false' && steps.merge.outputs.merge_success == 'true'
        id: build
        run: |
          npm ci
          if npm run build; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build successful"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build failed"
          fi

      - name: Push to main (merge and build success)
        if: steps.merge.outputs.merge_success == 'true' && steps.build.outputs.build_success == 'true'
        run: |
          git push origin main
          echo "âœ… Successfully synced with upstream"

      - name: Close existing conflict issue (if resolved)
        if: steps.merge.outputs.merge_success == 'true' && steps.build.outputs.build_success == 'true' && steps.check_issue.outputs.exists == 'true'
        run: |
          gh issue close ${{ steps.check_issue.outputs.number }} --comment "âœ… å†²çªå·²è‡ªåŠ¨è§£å†³ï¼Œä¸Šæ¸¸åŒæ­¥æˆåŠŸï¼"
          echo "âœ… Closed existing conflict issue #${{ steps.check_issue.outputs.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: |
          steps.upstream_release.outputs.has_release == 'true' &&
          steps.local_release.outputs.exists == 'false' &&
          (steps.build.outputs.build_success == 'true' || steps.check.outputs.already_up_to_date == 'true')
        run: |
          UPSTREAM_TAG="${{ steps.upstream_release.outputs.tag }}"

          # å¦‚æœä»£ç å·²æ˜¯æœ€æ–°ä½†æ²¡æœ‰ releaseï¼Œéœ€è¦å…ˆæ„å»º
          if [ "${{ steps.check.outputs.already_up_to_date }}" == "true" ]; then
            npm ci
            npm run build
          fi

          # åˆ é™¤ä»ä¸Šæ¸¸ fetch æ¥çš„æœ¬åœ° tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git tag -d "$UPSTREAM_TAG" 2>/dev/null || true

          # è¯»å–ä¸Šæ¸¸ release body
          UPSTREAM_BODY=""
          if [ -f /tmp/upstream_release_body.md ]; then
            UPSTREAM_BODY=$(cat /tmp/upstream_release_body.md)
          fi

          # æ„å»º release notes å†™å…¥æ–‡ä»¶
          cat > /tmp/release_notes.md << 'RELEASE_EOF'
          ## ğŸ”„ åŒæ­¥ä¸Šæ¸¸

          æ­¤ç‰ˆæœ¬åŒæ­¥è‡ªä¸Šæ¸¸ä»“åº“ [router-for-me/Cli-Proxy-API-Management-Center](https://github.com/router-for-me/Cli-Proxy-API-Management-Center)

          ### âœ¨ Fork å¢å¼ºåŠŸèƒ½
          - Kiro (AWS CodeWhisperer) é…é¢æ˜¾ç¤º
          - GitHub Copilot é…é¢æ˜¾ç¤º

          ---

          ### ğŸ“‹ ä¸Šæ¸¸æ›´æ–°æ—¥å¿—

          RELEASE_EOF

          # è¿½åŠ ä¸Šæ¸¸ release body
          echo "$UPSTREAM_BODY" >> /tmp/release_notes.md

          # åˆ›å»º release å¹¶ä¸Šä¼ æ„å»ºäº§ç‰©
          gh release create "$UPSTREAM_TAG" \
            --title "$UPSTREAM_TAG" \
            --notes-file /tmp/release_notes.md \
            ./dist/index.html

          echo "âœ… Release $UPSTREAM_TAG created successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue (merge conflict)
        if: steps.merge.outputs.merge_success == 'false' && steps.check_issue.outputs.exists == 'false'
        run: |
          # è¯»å–å†²çªæ–‡ä»¶åˆ—è¡¨
          CONFLICT_LIST=""
          if [ -f /tmp/conflict_files.txt ]; then
            while IFS= read -r file; do
              [ -n "$file" ] && CONFLICT_LIST="${CONFLICT_LIST}- \`${file}\`"$'\n'
            done < /tmp/conflict_files.txt
          fi

          # å†™å…¥ issue body åˆ°æ–‡ä»¶
          cat > /tmp/issue_body.md << ISSUE_EOF
          ## è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ—¶å‘ç°åˆå¹¶å†²çª

          ### ğŸ”´ å†²çªæ–‡ä»¶
          ${CONFLICT_LIST}
          ### ğŸ› ï¸ è§£å†³æ–¹æ³•

          è¯·å‚è€ƒ [docs/merge.md](../blob/main/docs/merge.md)

          ### ä¸Šæ¸¸ä»“åº“
          https://github.com/router-for-me/Cli-Proxy-API-Management-Center
          ISSUE_EOF

          gh issue create \
            --title "âš ï¸ ä¸Šæ¸¸åŒæ­¥å†²çª" \
            --label "sync-conflict" \
            --body-file /tmp/issue_body.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue (build failed)
        if: steps.merge.outputs.merge_success == 'true' && steps.build.outputs.build_success == 'false'
        run: |
          git reset --hard HEAD~1

          cat > /tmp/issue_body.md << 'ISSUE_EOF'
          ## è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸åæ„å»ºå¤±è´¥

          åˆå¹¶æˆåŠŸä½†æ„å»ºå¤±è´¥ï¼Œå·²è‡ªåŠ¨å›æ»šã€‚

          ### ğŸ› ï¸ è§£å†³æ–¹æ³•

          è¯·å‚è€ƒ [docs/merge.md](../blob/main/docs/merge.md)

          ### ä¸Šæ¸¸ä»“åº“
          https://github.com/router-for-me/Cli-Proxy-API-Management-Center
          ISSUE_EOF

          gh issue create \
            --title "âŒ ä¸Šæ¸¸åŒæ­¥æ„å»ºå¤±è´¥" \
            --label "build-failed" \
            --body-file /tmp/issue_body.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
